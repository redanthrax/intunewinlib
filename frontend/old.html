<!DOCTYPE html>
<html>
<head>
    <title>Intune Win32 App Wizard</title>
    <script src="//unpkg.com/alpinejs" defer></script>
</head>
<body>
<h1>Prepare MSI for Intune Win32 App</h1>
<div x-data="fileUploader()">
    <form @submit.prevent="uploadFile">
        <input type="file" accept=".msi" @change="fileChosen" />
        <button type="submit">Upload</button>
    </form>
    <h2 x-text="status"></h2>
</div>

<script>
    function fileUploader() {
        return {
            file: null,
            status: "Waiting for file...",
            isUploading: false,
            uploadComplete: false,
            fileChosen(event) {
                this.file = event.target.files[0];
                this.status = "Ready to upload."
            },
            async uploadFile() {
                this.status = "Getting token"
                const resp = await fetch("/api/GetStorage",{
                    method: "GET",
                });

                if (!resp.ok) {
                    alert("Could not get token");
                }

                const sasUrl = await resp.text();
                this.status = "Uploading file. Please wait, this part can take a while..."
                const requestOptions = {
                    method: 'PUT',
                    headers: {
                        'x-ms-blob-type': 'BlockBlob'
                    },
                    body: this.file
                };

                try {
                    const response = await fetch(sasUrl, requestOptions);
                    if (response.ok) {
                        this.status = "Upload complete. Processing file..."
                        const fResp = await fetch("/api/CreatePackage", {
                            method: "POST",
                            body: sasUrl
                        }).then(res => res.blob())
                        .then(blob => {
                            this.downloadFile(blob, this.file.name);
                        });
                    } else {
                        this.status = "Upload failed."
                    }
                } catch (error) {
                    this.status = "There was an error";
                }           
            },
            downloadFile(blob, fileName) {
              const newFileName = fileName.replace(/\.[^/.]+$/, "") + ".intunewin";
              
              // Create a link element, set the href to the blob URL and trigger the download
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = newFileName;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              a.remove();
              this.status = "Package complete."
            }
        };
    }
</script>

</body>
</html>
