<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Upload</title>
    <!-- Include Alpine.js -->
    <script src="//unpkg.com/alpinejs" defer></script>
</head>
<body>
    <!-- Alpine.js Component for File Upload -->
    <div x-data="fileUpload()">
        <input type="file" @change="convertToBase64">
        <button @click="uploadFile">Upload</button>
        <p x-text="status"></p>
    </div>

    <script>
      function fileUpload() {
        return {
            fileName: '',
            fileContents: '',
            status: 'Waiting for file...',

            convertToBase64(event) {
              this.status = "Converting file to base64...";
                const file = event.target.files[0];
                this.fileName = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.fileContents = e.target.result.split(',')[1];
                };
                reader.readAsDataURL(file);
                this.status = "Ready to upload."
            },

            uploadFile() {
              this.status = "Uploading file...";
              const payload = {
                fileName: this.fileName,
                fileContents: this.fileContents
              };

              fetch('/api/CreatePackage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
              })
              .then(response => response.blob())
              .then(blob => {
                this.downloadFile(blob, this.fileName);
              })
              .catch(error => console.error('Error:', error));
            },
            downloadFile(blob, fileName) {
              this.status = "Download ready";
              // Change file extension to .intunewin
              const newFileName = fileName.replace(/\.[^/.]+$/, "") + ".intunewin";
              
              // Create a link element, set the href to the blob URL and trigger the download
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = newFileName;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              a.remove();
            }
        };
      }
    </script>
</body>
</html>